/**
 * Extend Mongoose by adding a paginate method to queries.
 *
 * @param {Mongoose} mongoose
 * @api public
 */

module.exports = function(mongoose) {
  if (!mongoose) mongoose = require('mongoose');
  
  /**
   * Paginate query results.
   *
   * @param {Number} page
   * @param {Number} limit
   * @param {Function} cb
   * @return {Query}
   * @api public
   */
  
  mongoose.Query.prototype.paginate = function paginate (page, limit, cb) {
    page = parseInt(page, 10) || 1;
    limit = parseInt(limit, 10) || 10;
    
    var query = this;
    var model = this.model;
    var skipFrom = (page * limit) - limit;
    
    query = query.skip(skipFrom).limit(limit);
    
    if(cb) {
      query.exec(function(err, docs) {
        if(err) return cb(err, null, null);
        model.count(query._conditions, function(err, total) {
          if(err) return cb(err, null, null);
          cb(null, docs, total);
        });
      });
    } else {
      return this;
    }
  };
};